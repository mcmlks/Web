<!-- /Public/利用可能施設.html -->
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MCML | 利用可能施設</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#0b1020; --panel:#111a31; --panel2:#0d1426; --line:#1c2744;
    --text:#e5e7eb; --muted:#9aa4b2; --brand:#22d3ee; --ok:#34d399; --danger:#ef4444;
    --radius:16px; --shadow:0 12px 32px rgba(0,0,0,.35); --max:1100px;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f7f9fc; --panel:#eef2f8; --panel2:#ffffff; --line:#e5ebf4; --text:#101727; --muted:#58657a; --shadow:0 10px 28px rgba(2,6,23,.08) }
  }
  *{box-sizing:border-box}
  body{margin:0; font:15px/1.7 system-ui,-apple-system,"Segoe UI",Inter,Roboto,"Noto Sans JP",sans-serif; color:var(--text); background:linear-gradient(180deg,var(--bg),#0a0f1b);}
  .wrap{max-width:var(--max); margin:0 auto; padding:24px}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow)}
  .inner{padding:18px 20px}
  .h1{font-size:clamp(22px,3.6vw,32px); font-weight:900; margin:0 0 4px}
  .lead{color:var(--muted); margin:6px 0 0}
  .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; background:var(--brand); color:#061018; font-weight:800; border:0; cursor:pointer}
  .btn.ghost{background:transparent; border:1px solid var(--line); color:var(--text)}
  .grid{display:grid; gap:14px}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  @media (max-width: 900px){ .cols-3{grid-template-columns:1fr 1fr} }
  @media (max-width: 640px){ .cols-3{grid-template-columns:1fr} }
  .item{display:flex; gap:12px}
  .thumb{flex:0 0 96px; height:72px; border-radius:12px; background:#0d172b center/cover no-repeat; border:1px solid var(--line)}
  .meta b{display:block; font-weight:900}
  .meta small{color:var(--muted)}
  .author{display:flex; align-items:center; gap:8px; color:var(--muted)}
  .author img{width:20px; height:20px; border-radius:999px}

  /* Modal */
  .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.5); z-index:60}
  .modal.open{display:grid}
  .sheet{width:min(720px, 94vw); background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow)}
  .sheet .head{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 16px; border-bottom:1px solid var(--line)}
  .sheet .body{padding:16px}
  .sheet .row{display:grid; grid-template-columns:120px 1fr; gap:12px; align-items:center; margin:10px 0}
  .sheet input,.sheet textarea{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:color-mix(in oklab,var(--text) 6%, transparent); color:var(--text)}
  .sheet textarea{min-height:96px; resize:vertical}
  .close{background:transparent; border:1px solid var(--line); border-radius:10px; padding:6px 10px; cursor:pointer}
  .who{display:flex; align-items:center; gap:8px}
  .who img{width:28px; height:28px; border-radius:999px; border:1px solid var(--line)}
  .actions{display:flex; justify-content:flex-end; gap:10px; padding:0 16px 16px}
  .err{color:var(--danger); font-weight:700; font-size:13px}
  .toast{position:fixed; left:50%; top:14px; transform:translateX(-50%); background:#000c; color:#fff; padding:10px 14px; border-radius:12px; z-index:80}
</style>
</head>
<body>

<!-- 共通ヘッダー -->
<!--#include "/Public/Base.html" -->

<main class="wrap">
  <section class="card">
    <div class="inner" style="display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap">
      <div>
        <h1 class="h1">利用可能施設</h1>
        <p class="lead">サーバー内で使える施設（ショップ、トラップ、公共施設など）をみんなで共有します。</p>
      </div>
      <div id="who" class="who" style="display:none">
        <img id="whoAvatar" alt="">
        <span id="whoName" class="lead"></span>
      </div>
      <div>
        <button id="openNew" class="btn">+ 施設を登録</button>
      </div>
    </div>
  </section>

  <section class="wrap" style="padding:0">
    <div id="list" class="grid cols-3"></div>
  </section>
</main>

<!-- Modal -->
<div id="modal" class="modal" aria-modal="true" role="dialog">
  <div class="sheet" role="document">
    <div class="head">
      <strong>施設を登録</strong>
      <div class="who"><img id="mAvatar" alt=""><span id="mName"></span></div>
      <button id="closeModal" class="close">✕</button>
    </div>
    <div class="body">
      <div class="row"><label>名称*</label><input id="fName" maxlength="80" required></div>
      <div class="row"><label>カテゴリ</label><input id="fCat" placeholder="例: トラップ / 店舗 / 公共施設"></div>
      <div class="row"><label>座標</label><input id="fCoords" placeholder="例: X:123 Y:64 Z:-456"></div>
      <div class="row"><label>URL</label><input id="fLink" placeholder="案内スレ/地図/説明のリンク等"></div>
      <div class="row"><label>画像URL</label><input id="fImg" placeholder="サムネに使う画像URL（任意）"></div>
      <div class="row" style="grid-template-columns:1fr"><textarea id="fDesc" placeholder="説明（500文字まで）" maxlength="500"></textarea></div>
      <div id="err" class="err" style="display:none"></div>
    </div>
    <div class="actions">
      <button id="cancel" class="btn ghost">キャンセル</button>
      <button id="submit" class="btn">保存して公開</button>
    </div>
  </div>
</div>

<script>
  const $ = s => document.querySelector(s);
  let me = null;

  function toast(msg){ const t = document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; },1100); setTimeout(()=>t.remove(),1500); }

  async function fetchJSON(url, opt){
    const r = await fetch(url, Object.assign({credentials:'same-origin'}, opt));
    if(!r.ok) throw new Error(await r.text());
    return r.json();
  }

  function renderList(items){
    const el = $("#list"); el.innerHTML = "";
    if(!Array.isArray(items) || items.length===0){
      const d = document.createElement('div');
      d.className='card inner'; d.textContent = "まだ登録はありません。右上の「+ 施設を登録」からどうぞ。";
      el.appendChild(d); return;
    }
    items.forEach(it=>{
      const card = document.createElement('div'); card.className='card inner item';
      const th = document.createElement('div'); th.className='thumb'; if(it.image_url) th.style.backgroundImage=`url('${it.image_url}')`;
      const meta = document.createElement('div'); meta.className='meta';
      const a = document.createElement('a'); a.href = it.link_url || "#"; a.target = it.link_url ? "_blank" : "";
      a.innerHTML = `<b>${it.name}</b><small>${it.category||"その他"}・${it.coords||""}</small><p style="margin:.3rem 0 0">${(it.description||"").replace(/[<>]/g,'')}</p>`;
      meta.appendChild(a);
      const au = document.createElement('div'); au.className='author';
      au.innerHTML = `<img src="${it.author_avatar||''}" alt=""><small>${it.author_name||'Member'}</small>`;
      meta.appendChild(au);
      card.appendChild(th); card.appendChild(meta);
      el.appendChild(card);
    });
  }

  function setWho(u){
    if(!u) { $("#who").style.display='none'; return; }
    $("#whoAvatar").src = u.avatar_url; $("#whoName").textContent = u.display_name; $("#who").style.display='';
    $("#mAvatar").src = u.avatar_url; $("#mName").textContent = u.display_name;
  }

  async function load(){
    me = await fetchJSON("/api/me");
    if(!me.logged_in){
      $("#openNew").onclick = () => { toast("投稿にはログインが必要です"); location.href="/auth/discord/login?next="+encodeURIComponent(location.pathname); };
      setWho(null);
    }else{
      $("#openNew").onclick = () => openModal();
      setWho(me);
    }
    const items = await fetchJSON("/api/facilities");
    renderList(items);
  }

  function openModal(){ $("#modal").classList.add("open"); document.body.style.overflow="hidden"; }
  function closeModal(){ $("#modal").classList.remove("open"); document.body.style.overflow=""; $("#err").style.display='none'; }
  $("#closeModal").onclick = closeModal;
  $("#cancel").onclick = closeModal;
  $("#modal").addEventListener('click', e=>{ if(e.target.id==="modal") closeModal(); });

  $("#submit").addEventListener('click', async ()=>{
    if(!me || !me.logged_in){ toast("ログインしてください"); return; }
    const name = $("#fName").value.trim();
    if(!name){ $("#err").textContent="名称は必須です"; $("#err").style.display='block'; return; }
    const payload = {
      name,
      category: $("#fCat").value,
      coords: $("#fCoords").value,
      description: $("#fDesc").value,
      image_url: $("#fImg").value,
      link_url: $("#fLink").value
    };
    $("#err").style.display='none';
    try{
      const r = await fetch("/api/facilities", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
      if(!r.ok) throw new Error(await r.text());
      const item = await r.json();
      toast("登録しました");
      // 先頭に反映
      const cur = await fetchJSON("/api/facilities");
      renderList(cur);
      closeModal();
      // 初期化
      ["#fName","#fCat","#fCoords","#fDesc","#fImg","#fLink"].forEach(s=>$(s).value="");
    }catch(e){
      $("#err").textContent = "保存に失敗しました: " + (e.message||e);
      $("#err").style.display='block';
    }
  });

  load();
</script>
</body>
</html>
