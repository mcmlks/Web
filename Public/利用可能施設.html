<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>施設 編集申請キュー</title>
  <style>
    :root { --bg:#0b0c10; --panel:#14161b; --muted:#8a8f98; --text:#e9edf1; --ok:#2ea043; --warn:#e3b341; --err:#d1395c; --border:#22252b; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif;}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0b0c10,#0b0c10cc);backdrop-filter:blur(6px);z-index:10;border-bottom:1px solid var(--border)}
    header .bar{display:flex;gap:.75rem;align-items:center;max-width:1100px;margin:0 auto;padding:10px 16px}
    h1{font-size:18px;margin:0}
    .me{margin-left:auto;font-size:12px;color:var(--muted);display:flex;align-items:center;gap:.5rem}
    .me img{width:22px;height:22px;border-radius:50%}
    main{max-width:1100px;margin:18px auto;padding:0 16px}
    .controls{display:flex;gap:.5rem;align-items:center;margin-bottom:14px}
    .controls input{flex:1;padding:.5rem .6rem;border:1px solid var(--border);border-radius:.6rem;background:#0e1015;color:var(--text)}
    .controls button{padding:.55rem .8rem;border:1px solid var(--border);background:#11141a;color:var(--text);border-radius:.6rem;cursor:pointer}
    .controls button.primary{background:#1a3b1f;border-color:#244a2a}
    .controls .hint{font-size:12px;color:var(--muted);margin-left:.4rem}
    .list{display:grid;gap:12px}
    .card{border:1px solid var(--border);background:var(--panel);border-radius:14px;padding:14px 14px}
    .card h3{margin:.1rem 0 .4rem 0;font-size:16px}
    .meta{display:flex;flex-wrap:wrap;gap:.75rem;color:var(--muted);font-size:12px;margin-bottom:.35rem}
    .submitter{display:flex;align-items:center;gap:.4rem}
    .submitter img{width:20px;height:20px;border-radius:50%}
    .status{padding:.15rem .5rem;border-radius:999px;border:1px solid var(--border);font-size:11px}
    .status.pending{background:#17140d;color:#e6c37a;border-color:#3b2f16}
    .status.applied{background:#0f1a12;color:#8fe39a;border-color:#1e3a25}
    .status.rejected{background:#1a0f12;color:#f3a7ba;border-color:#3a1e27}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap;margin:.5rem 0 .6rem}
    .actions button{padding:.45rem .7rem;border-radius:.5rem;border:1px solid var(--border);background:#11141a;color:var(--text);cursor:pointer}
    .actions button.apply{background:#15331c;border-color:#22452a}
    .actions button.reject{background:#32141e;border-color:#4a2330}
    .diff{font-size:12px;color:#bfc6ce;margin:.25rem 0 .2rem}
    details{border:1px dashed var(--border);border-radius:10px;padding:.3rem .6rem;background:#0e1116}
    details > summary{cursor:pointer;list-style: none}
    details > summary::-webkit-details-marker{display:none}
    details pre{margin:.4rem 0 .2rem;white-space:pre-wrap;word-break:break-word}
    pre{font:12px/1.4 ui-monospace,SFMono-Regular,Menlo,Consolas,Monaco,monospace;background:#0c0f14;color:#e6eef6;padding:.6rem;border-radius:.6rem;border:1px solid var(--border);overflow:auto}
    .empty{color:var(--muted);text-align:center;padding:30px 0}
    .error{color:#ffc7d4;background:#3a1e27;border:1px solid #4a2330;padding:.6rem;border-radius:.6rem;margin:.6rem 0}
    .pill{font-size:11px;padding:.1rem .45rem;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
    footer{color:var(--muted);font-size:12px;text-align:center;padding:22px 0 28px}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>施設・編集申請キュー</h1>
      <div class="me" id="me"><span class="pill">未ログイン</span></div>
    </div>
  </header>

  <main>
    <div class="controls">
      <input id="q" type="search" placeholder="検索: 施設名 / カテゴリ / タグ / 説明 など…" />
      <button id="btnRefresh" class="primary">再読み込み</button>
      <span class="hint">ステータス: pending / applied / rejected</span>
    </div>

    <div id="err" class="error" style="display:none"></div>
    <div id="list" class="list"></div>
    <div id="empty" class="empty" style="display:none">申請はありません。</div>

    <footer>MCML Admin</footer>
  </main>

  <script>
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
  const esc = (s) => (s ?? '').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const fmtTime = (sec) => {
    if (!sec) return '';
    const d = new Date(Number(sec) * 1000);
    const p = n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}/${p(d.getMonth()+1)}/${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
  };

  const meBox = $('#me');
  fetch('/api/me').then(r=>r.json()).then(me=>{
    if (me?.logged_in) {
      meBox.innerHTML = `<img src="${esc(me.avatar_url)}" alt=""><span>${esc(me.display_name)}</span>${me.is_admin?'<span class="pill">Admin</span>':'<span class="pill">Member</span>'}`;
    } else {
      meBox.innerHTML = `<span class="pill">未ログイン</span>`;
    }
  });

  let QUEUE = [];
  let FILTER = '';

  $('#q').addEventListener('input', (e)=>{ FILTER = (e.target.value||'').toLowerCase(); render(); });
  $('#btnRefresh').addEventListener('click', ()=> loadQueue());

  async function loadQueue() {
    showErr(); // clear
    $('#list').innerHTML = '';
    $('#empty').style.display = 'none';
    try {
      const res = await fetch('/api/facilities/queue');
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`GET /api/facilities/queue → ${res.status}: ${txt}`);
      }
      QUEUE = await res.json();
      render();
    } catch (e) {
      showErr(e.message || e);
    }
  }

  function showErr(msg='') {
    const box = $('#err');
    if (!msg) { box.style.display = 'none'; box.textContent = ''; return; }
    box.style.display = '';
    box.textContent = msg;
  }

  function render() {
    const list = $('#list');
    list.innerHTML = '';
    const kw = FILTER;
    const items = QUEUE.filter(it=>{
      if (!kw) return true;
      const before = JSON.stringify(it.before || {});
      const patch  = JSON.stringify(it.patch  || {});
      const hay = [
        it.title, it.target_name, it.target_category, it.status,
        it.submitter?.name, before, patch
      ].join(' ').toLowerCase();
      return hay.includes(kw);
    });

    if (!items.length) {
      $('#empty').style.display = '';
      return;
    }
    $('#empty').style.display = 'none';

    for (const req of items) {
      const before = req.before || {};
      const after  = req.patch  || {};
      const title  = req.title || req.target_name || before.name || '(名称不明)';
      const status = (req.status || 'pending').toLowerCase();

      const changedKeys = Object.keys(after).filter(k => JSON.stringify(before?.[k]) !== JSON.stringify(after[k]));

      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        <h3>${esc(title)} に対する編集申請</h3>
        <div class="meta">
          <span class="status ${esc(status)}">${esc(status)}</span>
          <span>施設ID: <code>${esc(req.facility_id)}</code></span>
          <span>申請ID: <code>${esc(req.req_id)}</code></span>
          ${req.created_at ? `<span>作成: ${esc(fmtTime(req.created_at))}</span>`:''}
          ${req.decided_at ? `<span>決定: ${esc(fmtTime(req.decided_at))}</span>`:''}
          <span class="submitter">
            ${req.submitter?.avatar ? `<img src="${esc(req.submitter.avatar)}" alt="">` : ''}
            申請者: ${esc(req.submitter?.name || 'Member')}
          </span>
          ${req.decided_by ? `<span>決定者: ${esc(req.decided_by.name||'')}</span>`:''}
          ${req.reason ? `<span>理由: ${esc(req.reason)}</span>`:''}
        </div>

        <div class="actions">
          <button class="apply"  data-apply="${esc(req.req_id)}" ${status!=='pending'?'disabled':''}>適用</button>
          <button class="reject" data-reject="${esc(req.req_id)}" ${status!=='pending'?'disabled':''}>却下</button>
        </div>

        ${changedKeys.length ? `<div class="diff">変更フィールド: ${changedKeys.map(k=>`<code>${esc(k)}</code>`).join(' ')}</div>` : `<div class="diff">変更フィールド: なし</div>`}

        <details open>
          <summary><strong>変更後（patch）</strong></summary>
          <pre id="after-${esc(req.req_id)}"></pre>
        </details>
        <details>
          <summary><strong>変更前（before）</strong></summary>
          <pre id="before-${esc(req.req_id)}"></pre>
        </details>
      `;
      list.appendChild(card);

      // JSONは必ず textContent で（XSS防止）
      $(`#after-${CSS.escape(req.req_id)}`).textContent  = JSON.stringify(after,  null, 2);
      $(`#before-${CSS.escape(req.req_id)}`).textContent = JSON.stringify(before, null, 2);
    }
  }

  // ボタン（適用／却下）
  document.addEventListener('click', async (ev) => {
    const btn = ev.target.closest('button[data-apply],button[data-reject]');
    if (!btn) return;

    const isApply = btn.hasAttribute('data-apply');
    const reqId = btn.getAttribute(isApply ? 'data-apply' : 'data-reject');
    btn.disabled = true;

    try {
      if (isApply) {
        await doApply(reqId);
      } else {
        const reason = prompt('却下理由（任意）を入力してください：') ?? '';
        await doReject(reqId, reason.trim());
      }
      await loadQueue(); // 成功後に再読込
    } catch (e) {
      showErr(e.message || e);
    } finally {
      btn.disabled = false;
    }
  });

  async function doApply(reqId) {
    const res = await fetch(`/api/facilities/queue/${encodeURIComponent(reqId)}/apply`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: '{}' // 空でもOK。明示しておく
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`apply失敗 (${res.status}): ${txt}`);
    }
  }

  async function doReject(reqId, reason) {
    const res = await fetch(`/api/facilities/queue/${encodeURIComponent(reqId)}/reject`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reason })
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`reject失敗 (${res.status}): ${txt}`);
    }
  }

  // 初回ロード
  loadQueue();
  </script>
</body>
</html>
