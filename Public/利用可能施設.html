<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>利用可能施設</title>
<style>
  :root{
    --bg:#0f1115; --fg:#e7e7e9; --muted:#9aa0a6; --card:#151821; --accent:#6aa5ff; --danger:#ff6a6a; --ok:#39d98a; --warn:#ffc857;
    --br:14px;
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  a{color:var(--accent);text-decoration:none}
  header{position:sticky;top:0;background:linear-gradient(180deg,#0f1115 0%,rgba(15,17,21,.92) 100%);backdrop-filter:saturate(1.1) blur(6px);z-index:10;border-bottom:1px solid #1f2330}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .toolbar{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .input, select{
    background:#0e1420;border:1px solid #263048;color:var(--fg);padding:10px 12px;border-radius:10px;min-width:0
  }
  .btn{background:#1a2132;border:1px solid #2a3553;color:var(--fg);padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.primary{background:#20325a;border-color:#35518e}
  .btn.ghost{background:transparent;border-color:#2a3553}
  .btn.warn{background:#2a281a;border-color:#5f4c1a;color:#ffd27a}
  .btn.ok{background:#133022;border-color:#235a3a;color:#a6f3c7}
  .btn.danger{background:#2e1a1a;border-color:#5a2323;color:#ff9c9c}
  .section-title{margin:18px 0 10px;color:#cbd0d6;font-size:14px;letter-spacing:.05em}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
  .card{background:var(--card);border:1px solid #202534;border-radius:var(--br);overflow:hidden;position:relative;transition:transform .12s ease, box-shadow .12s ease}
  .card:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.25)}
  .thumb{width:100%;aspect-ratio:16/9;object-fit:cover;background:#0c0f15;cursor:pointer}
  .body{padding:12px;display:grid;gap:8px}
  .title{font-weight:700}
  .meta{color:var(--muted);font-size:12px}
  .desc{color:#cfd4db;font-size:14px;line-height:1.5;max-height:3.1em;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
  .card.expanded .desc{max-height:none;-webkit-line-clamp:unset}
  .card.expanded{outline:2px solid #2f3b58}
  .tags{display:flex;gap:6px;flex-wrap:wrap}
  .tag{font-size:12px;color:#b7c1d5;background:#141a25;border:1px solid #263048;padding:3px 6px;border-radius:999px}
  .row.small{gap:6px}
  .pin-handle{display:none;position:absolute;top:8px;left:8px;background:#0e1420;border:1px dashed #41537a;padding:6px 8px;border-radius:10px;font-size:12px;cursor:grab;user-select:none}
  .edit-btns{display:none;position:absolute;top:8px;right:8px;gap:6px}
  .edit-btns .btn{padding:6px 10px;font-size:12px}
  body.editing .pin-handle, body.editing .edit-btns{display:flex}
  .pinned-area{border:1px dashed #2a3553;border-radius:var(--br);padding:12px}
  .notice{background:#141a25;border:1px solid #263048;color:#dfe6f5;border-radius:12px;padding:10px}
  /* admin queue */
  .admin-box{display:none;margin:16px 0 0}
  .admin-box.active{display:block}
  .queue-item{background:#151a24;border:1px solid #2a3553;border-radius:12px;padding:10px;margin:8px 0}
  .diff{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;background:#0f141e;padding:8px;border-radius:8px;white-space:pre-wrap}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="toolbar">
      <div class="row">
        <input id="q" class="input" placeholder="検索（名前・説明・タグなど全文）" />
        <input id="tags" class="input" placeholder="タグ 絞り込み（例: 市場,鍛冶）" />
        <select id="category">
          <option value="">すべてのカテゴリ</option>
          <!-- 初期表示で空でもOK。取得後に動的に埋める -->
        </select>
        <button id="btn-search" class="btn">検索</button>
        <button id="btn-clear" class="btn ghost">クリア</button>
      </div>
      <div class="row">
        <button id="btn-edit" class="btn warn" title="並び替えモード">編集モード</button>
        <button id="btn-save-pins" class="btn ok" style="display:none">固定順を保存</button>
      </div>
      <div class="row">
        <span id="me" class="meta">未ログイン</span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="adminQueue" class="admin-box">
    <div class="notice">管理チーム向け：編集申請</div>
    <div id="queueList"></div>
  </div>

  <div class="section-title">固定（上部表示）</div>
  <div id="pinned" class="grid pinned-area"></div>

  <div class="section-title">すべて</div>
  <div id="all" class="grid"></div>
</main>

<template id="tpl-card">
  <div class="card" draggable="false">
    <div class="pin-handle" title="ドラッグして順序変更">📌 固定</div>
    <div class="edit-btns">
      <button class="btn ghost btn-edit-card">編集</button>
    </div>
    <img class="thumb" />
    <div class="body">
      <div class="title"></div>
      <div class="meta"></div>
      <div class="desc"></div>
      <div class="tags"></div>
    </div>
  </div>
</template>

<template id="tpl-tag"><span class="tag"></span></template>

<!-- 簡易編集モーダル -->
<dialog id="editModal">
  <form method="dialog" style="min-width:min(560px,90vw);background:#0f141e;color:#e8edf7;border:1px solid #2a3553;border-radius:12px;padding:16px">
    <h3>施設を編集</h3>
    <div class="row" style="margin:8px 0">
      <input class="input" id="em_name" placeholder="名前" style="flex:1">
      <input class="input" id="em_category" placeholder="カテゴリ（例: 商業）" style="width:180px">
    </div>
    <div class="row" style="margin:8px 0">
      <input class="input" id="em_coords" placeholder="座標 X,Y,Z / 地点名" style="flex:1">
    </div>
    <div class="row" style="margin:8px 0">
      <input class="input" id="em_image" placeholder="画像URL" style="flex:1">
      <input class="input" id="em_link"  placeholder="リンクURL" style="flex:1">
    </div>
    <div style="margin:8px 0">
      <textarea class="input" id="em_desc" placeholder="説明 / 利用用途（その他詳細）" style="width:100%;min-height:120px"></textarea>
    </div>
    <div style="margin:8px 0">
      <input class="input" id="em_tags" placeholder="タグ（カンマ区切り：市場,鍛冶,取引）" style="width:100%">
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button class="btn ghost" value="cancel">閉じる</button>
      <button class="btn primary" id="em_submit" value="default">送信</button>
    </div>
  </form>
</dialog>

<script>
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

let ME = { logged_in:false, id:null, display_name:"", avatar_url:"", is_admin:false };
let FAC = [];       // 取得済み施設
let PIN_ORDER = []; // 現在のpin順（ID配列）

async function api(path, opts={}) {
  const r = await fetch(path, {credentials:'include', ...opts});
  if (!r.ok) throw new Error(await r.text());
  return r.json().catch(()=> ({}));
}

async function loadMe(){
  const me = await api('/api/me');
  ME = me;
  $('#me').textContent = me.logged_in ? `👤 ${me.display_name}` : '未ログイン';
  if (me.is_admin) {
    try {
      const q = await api('/api/facilities/queue');
      $('#adminQueue').classList.add('active');
      renderQueue(q);
    } catch(e) {
      $('#adminQueue').classList.remove('active');
    }
  } else {
    $('#adminQueue').classList.remove('active');
  }
}

function cardFrom(item){
  const tpl = document.getElementById('tpl-card').content.firstElementChild.cloneNode(true);
  tpl.dataset.id = item.id;
  const thumb = tpl.querySelector('.thumb');
  thumb.src = item.image_url || 'https://placehold.co/800x450?text=No+Image';
  thumb.alt = item.name || '';
  thumb.addEventListener('click', () => tpl.classList.toggle('expanded'));

  tpl.querySelector('.title').textContent = item.name || '（名称未設定）';
  tpl.querySelector('.meta').textContent = [
    item.category || 'その他',
    item.coords || ''
  ].filter(Boolean).join(' / ');
  tpl.querySelector('.desc').textContent = item.description || '';

  const tags = item.tags || [];
  const tg = tpl.querySelector('.tags');
  tags.forEach(t=>{
    const el = document.getElementById('tpl-tag').content.firstElementChild.cloneNode(true);
    el.textContent = t;
    tg.appendChild(el);
  });

  // 編集ボタン（並び替えモードで表示）
  const ebtn = tpl.querySelector('.btn-edit-card');
  ebtn.addEventListener('click', (ev)=>{
    ev.stopPropagation();
    openEditModal(item);
  });

  // 並び替えモード用 ドラッグ
  const ph = tpl.querySelector('.pin-handle');
  ph.addEventListener('mousedown', ()=> tpl.draggable = true);
  tpl.addEventListener('dragstart', e=>{
    if(!document.body.classList.contains('editing')){ e.preventDefault(); return; }
    e.dataTransfer.setData('text/plain', item.id);
    e.dataTransfer.effectAllowed = 'move';
  });
  tpl.addEventListener('dragend', ()=> tpl.draggable = false);

  return tpl;
}

function mountCards(list, targetEl){
  targetEl.innerHTML = '';
  list.forEach(it => targetEl.appendChild(cardFrom(it)));
}

function splitPinned(arr){
  const pinned = arr.filter(x => x.pin === true).sort((a,b)=>{
    const ao = (a.pin_order ?? 1e9), bo = (b.pin_order ?? 1e9);
    return ao - bo || (b.created_at - a.created_at);
  });
  const normal = arr.filter(x => x.pin !== true).sort((a,b)=> b.created_at - a.created_at);
  return {pinned, normal};
}

function applySearchFilter(arr){
  const q = ($('#q').value || '').trim().toLowerCase();
  const tags = ($('#tags').value || '').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
  const cat = ($('#category').value || '').trim().toLowerCase();
  if(!q && !tags.length && !cat) return arr;

  return arr.filter(it=>{
    if(cat && (it.category||'').trim().toLowerCase() !== cat) return false;
    if(tags.length){
      const tset = new Set((it.tags||[]).map(x=> (x||'').trim().toLowerCase()));
      for(const t of tags){ if(!tset.has(t)) return false; }
    }
    if(q){
      const hay = [
        it.name, it.category, it.coords, it.description,
        it.image_url, it.link_url, it.author_name, (it.tags||[]).join(' ')
      ].map(x=> (x||'').toString().toLowerCase()).join(' ');
      if(!hay.includes(q)) return false;
    }
    return true;
  });
}

function refreshCategoryOptions(){
  const cats = Array.from(new Set(FAC.map(x=>x.category).filter(Boolean)));
  if (!cats.includes('拠点')) cats.push('拠点'); // 念のため既定カテゴリを補完
  cats.sort((a,b)=> a.localeCompare(b,'ja'));
  const sel = $('#category');
  const keep = sel.value;
  sel.innerHTML = '<option value="">すべてのカテゴリ</option>' +
                  cats.map(c=>`<option>${c}</option>`).join('');
  if (keep && cats.includes(keep)) sel.value = keep;
}

async function loadFacilities(){
  const params = new URLSearchParams();
  if($('#q').value) params.set('q',$('#q').value);
  if($('#category').value) params.set('category',$('#category').value);
  if($('#tags').value) params.set('tags',$('#tags').value);
  const arr = await api('/api/facilities' + (params.toString()?`?${params}`:'')); // サーバ検索
  FAC = arr; // 保持
  refreshCategoryOptions(); // ★ カテゴリを動的構築
  renderAll();
  try{
    const p = await api('/api/facilities/pins');
    PIN_ORDER = p.order || [];
  }catch{}
}

function renderAll(){
  const filtered = applySearchFilter(FAC);
  const {pinned, normal} = splitPinned(filtered);
  mountCards(pinned, $('#pinned'));
  mountCards(normal, $('#all'));
}

function setEditing(on){
  document.body.classList.toggle('editing', !!on);
  $('#btn-save-pins').style.display = on ? '' : 'none';
  // ドロップ領域（pinned内で並び替え / all→pinnedへ持ち上げ）
  const pinned = $('#pinned');
  pinned.addEventListener('dragover', e=>{
    if(!document.body.classList.contains('editing')) return;
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  });
  pinned.addEventListener('drop', e=>{
    if(!document.body.classList.contains('editing')) return;
    e.preventDefault();
    const id = e.dataTransfer.getData('text/plain');
    const card = document.querySelector(`.card[data-id="${CSS.escape(id)}"]`);
    if(card){ pinned.prepend(card); }
  });

  // pinned内部の並び替え（ドラッグ先の前に挿入）
  $$('#pinned .card').forEach(card=>{
    card.addEventListener('dragover', e=>{
      if(!document.body.classList.contains('editing')) return;
      e.preventDefault();
      const draggingId = e.dataTransfer.getData('text/plain');
      const dragging = document.querySelector(`.card[data-id="${CSS.escape(draggingId)}"]`);
      if(!dragging || dragging===card) return;
      const rect = card.getBoundingClientRect();
      const before = (e.clientY - rect.top) < rect.height/2;
      card.parentElement.insertBefore(dragging, before? card: card.nextSibling);
    });
  });
}

async function savePins(){
  const ids = $$('#pinned .card').map(c=> c.dataset.id);
  try{
    await api('/api/facilities/pins', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({order: ids})
    });
    await loadFacilities();
    alert('固定順を保存しました');
  }catch(e){
    alert('保存に失敗しました: ' + e.message);
  }
}

function openEditModal(item){
  const dlg = $('#editModal');
  $('#em_name').value = item.name || '';
  $('#em_category').value = item.category || '';
  $('#em_coords').value = item.coords || '';
  $('#em_image').value = item.image_url || '';
  $('#em_link').value  = item.link_url || '';
  $('#em_desc').value  = item.description || '';
  $('#em_tags').value  = (item.tags||[]).join(',');

  dlg.returnValue = '';
  dlg.showModal();

  $('#em_submit').onclick = async (ev)=>{
    ev.preventDefault();
    const patch = {
      name: $('#em_name').value,
      category: $('#em_category').value,
      coords: $('#em_coords').value,
      image_url: $('#em_image').value,
      link_url: $('#em_link').value,
      description: $('#em_desc').value,
      tags: $('#em_tags').value
    };
    try{
      const res = await api('/api/facilities/update', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({id: item.id, patch})
      });
      if(res.applied){
        alert('変更を適用しました（管理者）');
      }else if(res.queued){
        alert('編集申請を送信しました（承認待ち）');
      }else{
        alert('応答: ' + JSON.stringify(res));
      }
      dlg.close();
      await loadFacilities();
      if(ME.is_admin) await loadQueue();
    }catch(e){
      alert('送信に失敗しました: ' + e.message);
    }
  };
}

function renderQueue(list){
  const box = $('#queueList');
  box.innerHTML = '';
  (list||[]).filter(x=>x.status==='pending').forEach(it=>{
    // ★ APIが返すスナップショット/タイトルを優先
    const before = it.before || {};
    const after  = {...before, ...(it.patch||{})};
    const title  = it.title || it.target_name || before.name || '(名称不明)';

    const el = document.createElement('div');
    el.className = 'queue-item';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <div>
          <div><b>${title}</b> に対する編集申請</div>
          <div class="meta">申請者: ${it.submitter?.name||''}</div>
        </div>
        <div class="row small">
          <button class="btn ok btn-apply">適用</button>
          <button class="btn danger btn-reject">却下</button>
        </div>
      </div>
      <div class="diff" style="margin-top:8px"></div>
    `;
    const diff = el.querySelector('.diff');
    diff.textContent =
      '変更前:\n' + JSON.stringify({
        name: before.name, category: before.category, coords: before.coords,
        image_url: before.image_url, link_url: before.link_url,
        description: before.description, tags: before.tags
      }, null, 2)
      + '\n\n変更後:\n' + JSON.stringify({
        name: after.name, category: after.category, coords: after.coords,
        image_url: after.image_url, link_url: after.link_url,
        description: after.description, tags: after.tags
      }, null, 2);

    el.querySelector('.btn-apply').onclick = async ()=>{
      try{ await api(`/api/facilities/queue/${encodeURIComponent(it.req_id)}/apply`, {method:'POST'}); }
      catch(e){ alert('適用に失敗: '+e.message); return; }
      await Promise.all([loadFacilities(), loadQueue()]);
    };
    el.querySelector('.btn-reject').onclick = async ()=>{
      const reason = prompt('却下理由（任意）') || '';
      try{ await api(`/api/facilities/queue/${encodeURIComponent(it.req_id)}/reject`, {
        method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({reason})
      }); }
      catch(e){ alert('却下に失敗: '+e.message); return; }
      await loadQueue();
    };
    box.appendChild(el);
  });
}

async function loadQueue(){
  if (!ME.is_admin) { $('#adminQueue').classList.remove('active'); return; }
  try{
    const q = await api('/api/facilities/queue');
    $('#adminQueue').classList.add('active');
    renderQueue(q);
  }catch{
    $('#adminQueue').classList.remove('active');
  }
}

// events
$('#btn-search').addEventListener('click', loadFacilities);
$('#btn-clear').addEventListener('click', ()=>{
  $('#q').value=''; $('#tags').value=''; $('#category').value='';
  loadFacilities();
});
$('#btn-edit').addEventListener('click', ()=>{
  const on = !document.body.classList.contains('editing');
  setEditing(on);
  $('#btn-edit').textContent = on? '並び替えモード（ON）': '並び替えモード';
});
$('#btn-save-pins').addEventListener('click', savePins);

// init
(async function init(){
  await loadMe();
  await loadFacilities();
})();
</script>
    <!-- ===== Footer ===== -->
  <footer>
    <div class="container footer-grid">
      <div>
        <strong>MCML</strong>
        <p>ウェブの編集をリクエストするには（<a href="https://github.com/mcmlks/Web">こちら</a>）から</p>
        <p class="tiny">© <span id="year"></span>Minecraft は Mojang Studios の商標です。</p>
      </div>
      <div style="text-align:right">
        <a class="pill" href="#top">トップへ戻る ↑</a>
      </div>
    </div>
  </footer>

</body>
</html>
