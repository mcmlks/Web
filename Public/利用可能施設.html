<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ–½è¨­ä¸€è¦§ï¼ˆãƒ”ãƒ³å›ºå®šã¤ãï¼‰</title>
<meta name="color-scheme" content="light dark">
<style>
:root{
  --bg:#0b1020; --panel:#121b36; --panel2:#0e152b; --line:#1c2744;
  --text:#e5e7eb; --muted:#9aa4b2; --brand:#22d3ee; --ok:#34d399; --warn:#fde047; --danger:#ef4444;
  --radius:16px; --shadow:0 10px 28px rgba(0,0,0,.35); --max:1120px;
}
@media (prefers-color-scheme: light){
  :root{ --bg:#f6f8fb; --panel:#f1f5f9; --panel2:#ffffff; --line:#e6ebf2; --text:#0b1320; --muted:#55647a; --shadow:0 10px 22px rgba(2,6,23,.08) }
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,var(--bg),#091021);color:var(--text);font:15px/1.75 system-ui,-apple-system,Segoe UI,Inter,Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif}
a{color:inherit;text-decoration:none}
.wrap{max-width:var(--max);margin:0 auto;padding:18px}

.h1{font-size:clamp(22px,3.6vw,32px);margin:4px 0 12px;font-weight:900}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 16px}
input[type="search"],select{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:color-mix(in oklab,var(--text) 6%,transparent);color:var(--text)}
.badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:color-mix(in oklab,var(--text) 7%,transparent);font-weight:700;font-size:12px;color:var(--muted)}
.btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:color-mix(in oklab,var(--text) 6%,transparent);cursor:pointer}
.btn.primary{background:color-mix(in oklab,var(--brand) 24%,transparent);border-color:color-mix(in oklab,var(--brand) 50%,var(--line))}
.btn.danger{background:color-mix(in oklab,var(--danger) 24%,transparent);border-color:color-mix(in oklab,var(--danger) 50%,var(--line))}
.help{color:var(--muted);font-size:13px}

.section{margin:18px 0}
.card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
.card>.inner{padding:16px 16px}

.list{display:grid;gap:12px}
.list.grid{grid-template-columns:repeat(2,1fr)}
@media (max-width: 840px){ .list.grid{grid-template-columns:1fr} }

/* æ–½è¨­ã‚«ãƒ¼ãƒ‰ */
.facility{cursor:pointer;border-radius:14px;transition:box-shadow .2s ease,transform .2s ease;position:relative}
.facility:hover{transform:translateY(-1px)}
.facility .head{display:flex;gap:10px;align-items:center;margin-bottom:8px}
.facility .avatar{width:28px;height:28px;border-radius:50%;background:#0001;flex:0 0 auto}
.facility .name{font-weight:800;margin:0}
.facility .meta{font-size:12px;color:var(--muted)}
.facility .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.tag{font:700 11px/1 ui-sans-serif;padding:6px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);background:color-mix(in oklab,var(--text) 6%,transparent)}

.facility .media{margin:8px 0 10px}
.facility .media img{width:100%;max-height:140px;object-fit:cover;border-radius:12px;transition:max-height .25s ease}

/* èª¬æ˜ï¼šé–‰ã˜ã¦ã‚‹æ™‚ã¯1è¡Œã«çœç•¥ */
.facility .desc{
  display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;
  overflow:hidden;text-overflow:ellipsis;white-space:normal;
}
.facility.expanded .media img{max-height:360px}
.facility.expanded .desc{-webkit-line-clamp:unset;display:block}

/* ãƒ”ãƒ³UI */
.pinbar{display:flex;align-items:center;gap:10px;margin-top:6px}
.pinned-zone{border:1px dashed var(--line);border-radius:12px;padding:8px}
.pinned-zone .hint{color:var(--muted);font-size:13px;margin:0 0 6px}
.pinned-list{display:flex;flex-wrap:wrap;gap:8px;min-height:40px}
.pin-chip{padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:color-mix(in oklab,var(--brand) 10%,transparent);cursor:grab;user-select:none}
.pin-chip.dragging{opacity:.6}
.pin-btn{position:absolute;top:10px;left:10px;font-size:12px;padding:6px 8px;border-radius:10px;border:1px solid var(--line);background:color-mix(in oklab,var(--brand) 18%,transparent);display:none}
.facility.admin .pin-btn{display:inline-block}
.facility .caret{position:absolute;top:10px;right:12px;font-size:12px;opacity:.7;user-select:none}
.facility.expanded .caret{transform:rotate(90deg)}

/* éç®¡ç†è€…ã¸ã®ã‚¬ãƒ¼ãƒ‰è¡¨ç¤º */
.guard{padding:10px 12px;border:1px dashed var(--line);border-radius:12px;color:var(--muted);font-size:13px}
.warn{color:var(--warn)}
</style>
</head>
<body>
<main class="wrap">
  <h1 class="h1">åˆ©ç”¨å¯èƒ½æ–½è¨­</h1>

  <div class="controls">
    <input id="q" type="search" placeholder="æ–½è¨­åãƒ»èª¬æ˜ãƒ»ã‚¿ã‚°ãªã©ã§æ¤œç´¢">
    <select id="category"><option value="">ã‚«ãƒ†ã‚´ãƒªï¼ˆã™ã¹ã¦ï¼‰</option></select>
    <input id="tags" type="search" placeholder="ã‚¿ã‚°ï¼ˆ, åŒºåˆ‡ã‚Šã§ANDï¼‰">
    <button id="searchBtn" class="btn">æ¤œç´¢</button>
    <span id="adminBadge" class="badge" style="display:none">Admin</span>
  </div>

  <!-- ãƒ”ãƒ³ç·¨é›†ãƒ„ãƒ¼ãƒ«ï¼ˆç®¡ç†è€…ã®ã¿è¡¨ç¤ºï¼‰ -->
  <section id="pinTool" class="section card" style="display:none">
    <div class="inner">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <strong>ãƒ”ãƒ³å›ºå®š ç®¡ç†</strong>
        <div>
          <button id="pinEditToggle" class="btn">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
          <button id="pinSave" class="btn primary" style="display:none">é †åºã‚’ä¿å­˜</button>
          <button id="pinClear" class="btn danger" style="display:none">ã™ã¹ã¦å¤–ã™</button>
        </div>
      </div>
      <div class="pinned-zone" style="margin-top:10px">
        <p class="hint">ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ä¸¦ã¹æ›¿ãˆã€‚ä¸Šã‹ã‚‰è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        <div id="pinnedChips" class="pinned-list" aria-live="polite"></div>
      </div>
      <p id="pinGuard" class="guard" style="display:none">
        <span class="warn">ã‚µãƒ¼ãƒæœªå¯¾å¿œ:</span> <code>GET/POST /api/facilities/pins</code> ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ”ãƒ³é †ã¯è¡¨ç¤ºã®ã¿ãƒ»ä¿å­˜ã¯ã§ãã¾ã›ã‚“ã€‚
      </p>
    </div>
  </section>

  <!-- ãƒ”ãƒ³ç•™ã‚ã•ã‚ŒãŸæ–½è¨­ -->
  <section class="section" id="pinnedSection" style="display:none">
    <div class="card"><div class="inner">
      <h2 style="margin:0 0 6px">å›ºå®šè¡¨ç¤º</h2>
      <div id="pinnedList" class="list grid"></div>
    </div></div>
  </section>

  <!-- é€šå¸¸ãƒªã‚¹ãƒˆ -->
  <section class="section">
    <div class="card"><div class="inner">
      <h2 style="margin:0 0 6px">ã™ã¹ã¦ã®æ–½è¨­</h2>
      <div id="allList" class="list grid"></div>
    </div></div>
  </section>
</main>

<script>
const $ = sel => document.querySelector(sel);
const api = {
  me:         () => fetch('/api/me', {cache:'no-store'}).then(r=>r.json()),
  facilities: (params) => {
    const u = new URL('/api/facilities', location.origin);
    if (params?.q) u.searchParams.set('q', params.q);
    if (params?.category) u.searchParams.set('category', params.category);
    (params?.tags || []).forEach(t => u.searchParams.append('tag', t));
    return fetch(u, {cache:'no-store'}).then(r=>r.json());
  },
  pinsGet:    () => fetch('/api/facilities/pins', {cache:'no-store'}),
  pinsPost:   (order) => fetch('/api/facilities/pins', {
                  method:'POST', headers:{'Content-Type':'application/json'},
                  body: JSON.stringify({order})
                })
};

const state = {
  isAdmin: false,
  pinsAPI: {available:false, order:[]},
  facilities: [],
  filtered: [],
  categories: new Set(),
};

(async function init(){
  // èªè¨¼æƒ…å ±
  try{
    const me = await api.me();
    // Adminé…ä¸‹ã«ç½®ã‘ã°æ¨©é™ãƒã‚§ãƒƒã‚¯ã¯ã‚µãƒ¼ãƒå´ã§æ¸ˆã‚€ãŸã‚ã€ã“ã“ã§ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚Œã°Adminè¡¨ç¤ºã§OK
    state.isAdmin = !!me.logged_in; 
    if (state.isAdmin) $('#adminBadge').style.display = '';
  }catch(e){}

  // ãƒ”ãƒ³APIå­˜åœ¨ç¢ºèª
  try{
    const r = await api.pinsGet();
    state.pinsAPI.available = r.ok;
    if (r.ok){
      const j = await r.json();
      state.pinsAPI.order = Array.isArray(j?.order) ? j.order : [];
    } else {
      $('#pinGuard').style.display = '';
    }
  }catch(e){
    $('#pinGuard').style.display = '';
  }

  // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  await loadFacilities();
  applyFiltersFromInputs();
  renderAll();

  // UIã‚¤ãƒ™ãƒ³ãƒˆ
  $('#searchBtn').addEventListener('click', applyAndRender);
  $('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') applyAndRender(); });
  $('#category').addEventListener('change', applyAndRender);
  $('#tags').addEventListener('keydown', e=>{ if(e.key==='Enter') applyAndRender(); });

  // ãƒ”ãƒ³UIï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
  if (state.isAdmin){
    $('#pinTool').style.display = '';
    setupPinEditor();
  }
})();

async function loadFacilities(){
  const q = ($('#q').value||'').trim();
  const category = $('#category').value || '';
  const tags = ($('#tags').value||'').split(',').map(s=>s.trim()).filter(Boolean);

  const list = await api.facilities({q, category, tags});
  state.facilities = Array.isArray(list) ? list : [];

  // ã‚«ãƒ†ã‚´ãƒªé¸æŠè‚¢æ§‹ç¯‰
  state.categories = new Set(['', ...state.facilities.map(x => (x.category||'').trim()).filter(Boolean)]);
  const sel = $('#category');
  const current = sel.value;
  sel.innerHTML = '<option value="">ã‚«ãƒ†ã‚´ãƒªï¼ˆã™ã¹ã¦ï¼‰</option>' +
     [...state.categories].filter(c=>c).map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
  // å…¥åŠ›ç¶­æŒ
  [...sel.options].forEach(o=>{ if(o.value===current) sel.value=current; });

  // ãƒ”ãƒ³é †ï¼ˆå­˜åœ¨ã™ã‚Œã°é©ç”¨ï¼‰
  // - pinsAPI.order ã«ãªã„IDã¯ã€Œæœªãƒ”ãƒ³ã€ã¨ã—ã¦é€šå¸¸ãƒªã‚¹ãƒˆã«å›ã™
  // - orderã«ã‚ã‚‹ãŒæ–½è¨­ãŒè¦‹ã¤ã‹ã‚‰ãªã„IDã¯ç„¡è¦–
  state.pinned = [];
  if (state.pinsAPI.order?.length){
    const byId = Object.fromEntries(state.facilities.map(f=>[f.id,f]));
    state.pinsAPI.order.forEach(id => { if(byId[id]) state.pinned.push(byId[id]); });
  }
}

function applyAndRender(){ applyFiltersFromInputs(); renderAll(); }
function applyFiltersFromInputs(){
  const q = ($('#q').value||'').trim().toLowerCase();
  const category = ($('#category').value||'').trim().toLowerCase();
  const tags = ($('#tags').value||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);

  const matches = (item) => {
    if (category && (item.category||'').trim().toLowerCase() !== category) return false;
    if (tags.length){
      const its = (item.tags||[]).map(t=>String(t).trim().toLowerCase());
      for (const t of tags) if (!its.includes(t)) return false;
    }
    if (q){
      const hay = [
        item.name, item.category, item.coords, item.description,
        item.image_url, item.link_url, item.author_name, (item.tags||[]).join(' ')
      ].map(x=> (x||'').toString().toLowerCase()).join(' ');
      if (!hay.includes(q)) return false;
    }
    return true;
  };

  state.filtered = state.facilities.filter(matches);

  // ãƒ”ãƒ³ã•ã‚Œã¦ã„ãªã„è¦ç´ ã®æŠ½å‡º
  const pinnedIds = new Set(state.pinsAPI.order||[]);
  state.unpinned = state.filtered.filter(x => !pinnedIds.has(x.id));
}

function renderAll(){
  // ãƒ”ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³
  const pinSec = $('#pinnedSection');
  const pinList = $('#pinnedList');
  pinList.innerHTML = '';
  if ((state.pinsAPI.order||[]).length && state.filtered.length){
    const ids = new Set(state.filtered.map(f=>f.id));
    const shown = state.pinsAPI.order.filter(id => ids.has(id));
    if (shown.length){
      pinSec.style.display = '';
      shown.map(id => state.filtered.find(x=>x.id===id)).forEach(item=>{
        pinList.appendChild(renderFacilityCard(item, {admin: state.isAdmin}));
      });
    } else {
      pinSec.style.display = 'none';
    }
  } else {
    pinSec.style.display = 'none';
  }

  // é€šå¸¸ãƒªã‚¹ãƒˆ
  const all = $('#allList');
  all.innerHTML = '';
  (state.unpinned||state.filtered).forEach(item=>{
    all.appendChild(renderFacilityCard(item, {admin: state.isAdmin}));
  });

  // ã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ä»˜ä¸
  wireFacilityCards();
}

function renderFacilityCard(item, {admin=false}={}){
  const el = document.createElement('article');
  el.className = 'facility card';
  if (admin) el.classList.add('admin');
  el.dataset.id = item.id;
  el.innerHTML = `
    <button class="pin-btn" type="button" data-no-toggle data-id="${esc(item.id)}" title="å›ºå®š/è§£é™¤">ğŸ“Œ ãƒ”ãƒ³</button>
    <div class="caret">â–¶</div>
    <div class="inner">
      <div class="head">
        <img class="avatar" src="${esc(item.author_avatar||'')}" alt="">
        <div>
          <h3 class="name">${esc(item.name||'åç§°æœªè¨­å®š')}</h3>
          <div class="meta">${esc(item.category||'åˆ†é¡æœªè¨­å®š')} ãƒ» æŠ•ç¨¿: ${esc(item.author_name||'Member')}</div>
        </div>
      </div>
      ${item.image_url ? `<div class="media"><img src="${esc(item.image_url)}" alt=""></div>`:''}
      ${item.coords ? `<div class="meta">åº§æ¨™: ${esc(item.coords)}</div>`:''}
      ${item.link_url ? `<div class="meta"><a href="${esc(item.link_url)}" target="_blank" rel="noopener" data-no-toggle>å¤–éƒ¨ãƒªãƒ³ã‚¯</a></div>`:''}
      <p class="desc">${esc(item.description||'')}</p>
      ${Array.isArray(item.tags)&&item.tags.length? `<div class="tags">${item.tags.map(t=>`<span class="tag">${esc(t)}</span>`).join('')}</div>`:''}
    </div>
  `;
  return el;
}

function wireFacilityCards(){
  document.querySelectorAll('.facility').forEach(card=>{
    card.setAttribute('role','button');
    if(!card.hasAttribute('tabindex')) card.setAttribute('tabindex','0');
    if(!card.hasAttribute('aria-expanded')) card.setAttribute('aria-expanded','false');

    const toggle = () => {
      const expanded = card.classList.toggle('expanded');
      card.setAttribute('aria-expanded', expanded?'true':'false');
    };

    card.addEventListener('click', e=>{
      if (e.target.closest('[data-no-toggle],a,button,input,textarea,select,label')) return;
      toggle();
    });
    card.addEventListener('keydown', e=>{
      if (e.key==='Enter' || e.key===' ') { e.preventDefault(); toggle(); }
    });

    // ãƒ”ãƒ³ãƒœã‚¿ãƒ³
    const pinBtn = card.querySelector('.pin-btn');
    if (pinBtn){
      pinBtn.addEventListener('click', e=>{
        e.stopPropagation();
        const id = card.dataset.id;
        const idx = (state.pinsAPI.order||[]).indexOf(id);
        if (idx === -1) state.pinsAPI.order.unshift(id);
        else state.pinsAPI.order.splice(idx,1);
        applyFiltersFromInputs();
        renderAll();
        refreshPinEditor();
      });
    }
  });

  // ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§ã¯ã‚«ãƒ¼ãƒ‰é–‹é–‰ã¨é€£å‹•ï¼ˆexpandedã§èƒŒãŒä¼¸ã³ã‚‹ï¼‰
}

/* ====== ãƒ”ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ ====== */
function setupPinEditor(){
  $('#pinEditToggle').addEventListener('click', ()=>{
    const editing = document.body.classList.toggle('pin-editing');
    $('#pinSave').style.display = editing ? '' : 'none';
    $('#pinClear').style.display = editing ? '' : 'none';
    refreshPinEditor();
  });

  $('#pinClear').addEventListener('click', ()=>{
    state.pinsAPI.order = [];
    applyFiltersFromInputs();
    renderAll();
    refreshPinEditor();
  });

  $('#pinSave').addEventListener('click', async ()=>{
    if (!state.pinsAPI.available){
      alert('ã‚µãƒ¼ãƒãŒãƒ”ãƒ³ä¿å­˜APIã«æœªå¯¾å¿œã§ã™ã€‚');
      return;
    }
    try{
      const res = await api.pinsPost(state.pinsAPI.order);
      if (!res.ok) throw new Error(await res.text());
      alert('ä¿å­˜ã—ã¾ã—ãŸã€‚');
    }catch(err){
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
    }
  });

  refreshPinEditor();
}

function refreshPinEditor(){
  const zone = $('#pinnedChips');
  zone.innerHTML = '';
  (state.pinsAPI.order||[]).forEach(id=>{
    const item = state.facilities.find(x=>x.id===id);
    if (!item) return;
    const chip = document.createElement('div');
    chip.className = 'pin-chip';
    chip.draggable = true;
    chip.dataset.id = id;
    chip.textContent = item.name || '(ç„¡é¡Œ)';

    chip.addEventListener('dragstart', ()=>{
      chip.classList.add('dragging');
    });
    chip.addEventListener('dragend', ()=>{
      chip.classList.remove('dragging');
    });
    zone.appendChild(chip);
  });

  zone.addEventListener('dragover', (e)=>{
    e.preventDefault();
    const after = getDragAfterElement(zone, e.clientX, e.clientY);
    const dragging = zone.querySelector('.dragging');
    if (!dragging) return;
    if (after == null) zone.appendChild(dragging);
    else zone.insertBefore(dragging, after);
  });

  zone.addEventListener('drop', ()=>{
    // ä¸¦ã³ç›´ã—ã‚’çŠ¶æ…‹ã¸åæ˜ 
    state.pinsAPI.order = [...zone.querySelectorAll('.pin-chip')].map(n=>n.dataset.id);
    applyFiltersFromInputs();
    renderAll();
  });

  // Adminãƒ”ãƒ³UIã®è¡¨ç¤ºã‚¬ãƒ¼ãƒ‰
  $('#pinGuard').style.display = state.pinsAPI.available ? 'none':'';
  // ãƒ”ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºæ›´æ–°
  $('#pinnedSection').style.display = (state.pinsAPI.order||[]).length ? '' : 'none';
}

function getDragAfterElement(container, x, y){
  const els = [...container.querySelectorAll('.pin-chip:not(.dragging)')];
  return els.reduce((closest, child)=>{
    const rect = child.getBoundingClientRect();
    const offset = y - rect.top - rect.height/2;
    if (offset < 0 && offset > closest.offset) return {offset, element: child};
    else return closest;
  }, {offset: Number.NEGATIVE_INFINITY}).element;
}

/* ====== æ¤œç´¢ ====== */
function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function esc(s){ return escapeHtml(s); }
function applyFiltersFromInputsAndReload(){ applyFiltersFromInputs(); renderAll(); }

</script>
</body>
</html>
